rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // USER MANAGEMENT WITH APPROVAL SYSTEM
    // ============================================================================

    // Users collection - basic user data
    match /users/{userId} {
      // Users can read/write their own data
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Management team can read all users
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/management_team/$(request.auth.uid));
    }

    // Management team collection - server-side whitelist
    match /management_team/{userId} {
      // Only management team members can read the list
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/management_team/$(request.auth.uid));

      // Only Firebase Functions can write (server-side only)
      allow write: if request.auth == null;
    }

    // Helper function to check if user is management team
    function isManagementTeam(uid) {
      return exists(/databases/$(database)/documents/management_team/$(uid));
    }

    // Validate approval-related updates
    function validateApprovalUpdate(currentData, newData) {
      // Only allow changes to these fields by admins
      let allowedFields = ['isApproved', 'approvedBy', 'approvedAt', 'role', 'roleLevel', 'updatedAt'];

      // Check that only allowed fields are being modified
      let diff = newData.diff(currentData);
      return diff.changedKeys().hasOnly(allowedFields) &&
             // Additional validation for approval fields
             validateApprovalFields(newData);
    }

    // Validate approval field values
    function validateApprovalFields(data) {
      // isApproved must be boolean
      return (!data.keys().hasAny(['isApproved']) || data.isApproved is bool) &&
             // approvedBy must be string if present
             (!data.keys().hasAny(['approvedBy']) || !exists(data.approvedBy) || data.approvedBy is string) &&
             // role must be valid if present
             (!data.keys().hasAny(['role']) || data.role in ['USER', 'EDITOR', 'MANAGER', 'ADMIN', 'SUPER_ADMIN']) &&
             // Additional validation for approval workflow
             validateApprovalWorkflow(data);
    }

    // Validate approval workflow integrity
    function validateApprovalWorkflow(data) {
      // Simplified validation - allow all approval-related updates for now
      return true;
    }

    // Login attempts - SECURED: Only authenticated users can access, restricted by email ownership
    match /login_attempts/{email} {
      allow read, write: if request.auth != null &&
        request.auth.token.email == email; // User can only access their own login attempts
    }

    // Verification codes - SECURED: User can only access codes with their UID prefix
    match /verification_codes/{codeId} {
      allow read, write: if request.auth != null &&
        request.auth.uid == codeId.split('_')[0]; // User can only access codes with their UID prefix
    }

    // Invoices - management team only
    match /invoices/{invoiceId} {
      allow read, write: if request.auth != null &&
        isManagementTeam(request.auth.uid);
    }

    // Clients - management team only
    match /clients/{clientId} {
      allow read, write: if request.auth != null &&
        isManagementTeam(request.auth.uid);
    }

    // Quotations - management team only
    match /quotations/{quotationId} {
      allow read, write: if request.auth != null &&
        isManagementTeam(request.auth.uid);
    }

    // Proformas - management team only
    match /proformas/{proformaId} {
      allow read, write: if request.auth != null &&
        isManagementTeam(request.auth.uid);
    }

    // Projects - management team only
    match /projects/{projectId} {
      allow read, write: if request.auth != null &&
        isManagementTeam(request.auth.uid);
    }

    // POCs - management team only
    match /pocs/{pocId} {
      allow read, write: if request.auth != null &&
        isManagementTeam(request.auth.uid);
    }

    // PDF storage metadata - management team only
    match /invoice_pdfs/{pdfId} {
      allow read, write: if request.auth != null &&
        isManagementTeam(request.auth.uid);
    }

    // ============================================================================
    // APPROVAL SYSTEM COLLECTIONS
    // ============================================================================

    // Approval audit logs - management team only
    match /approval_audit_logs/{logId} {
      allow read, create: if request.auth != null &&
        isManagementTeam(request.auth.uid);
      // No updates or deletes - logs are immutable
      allow update, delete: if false;
    }

    // Admin notifications - management team only
    match /admin_notifications/{notificationId} {
      allow read, write: if request.auth != null &&
        isManagementTeam(request.auth.uid);
    }

    // Email delivery metrics - management team only
    match /email_delivery_metrics/{metricId} {
      allow read: if request.auth != null &&
        isManagementTeam(request.auth.uid);
      allow create: if request.auth == null; // Only Firebase Functions can create
      allow update, delete: if false; // Immutable metrics
    }

    // Audit logs - management team only
    match /audit_logs/{logId} {
      allow read, write: if request.auth != null &&
        isManagementTeam(request.auth.uid);
    }

    // ============================================================================
    // SECURITY: Explicit deny for all other access
    // ============================================================================

    // Deny all other access - explicit deny for security
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
